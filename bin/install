#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var utils = require('../utils');

utils.findGitRoot(function (err, root) {

    var createConfigFile = function (sourceName) {
        var destName = '.' + sourceName;
        var source = path.resolve(__dirname, '..', 'files', sourceName);
        var dest = path.join(root, '.' + sourceName);
        if (!fs.existsSync(dest)) {
            console.log('Creating default ' + destName);
            fs.writeFileSync(dest, fs.readFileSync(source));
        }
    };

    var sourcePath, destPath, hooksPath;

    if (err) {
        console.error('This project doesn\'t appear to be a git repository. To enable the pre-commit hook, run `git init` followed by `npm run precommit-hook install`.');
        return;
    }

    sourcePath = path.join(__dirname, 'pre-commit');
    destPath = path.join(root, '.git', 'hooks', 'pre-commit');
    hooksPath = path.dirname(destPath);

    // GitHub desktop app reportedly does not create the hooks directory, so let's create it here.
    if (!fs.existsSync(hooksPath)) {
        console.log('Creating .git/hooks...');
        fs.mkdirSync(hooksPath);
    }

    console.log('Creating .git/hooks/pre-commit...');
    fs.writeFileSync(destPath, fs.readFileSync(sourcePath, 'utf8'));
    fs.chmodSync(destPath, '755');

    ['jshintignore', 'jshintrc'].forEach(createConfigFile);
});
